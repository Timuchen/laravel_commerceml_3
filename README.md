# Протокол обмена информацией с 1С

Реализована поддержка протокола CommerceML 3.1. Протоколы более ранних версий на данном этапе не поддерживаются.
На стороне 1С должен использоваться модуль обмена 1C Битрикс. Тестирования с использованием узлов обмена для протокола CommerceML 3.1 не проводилось.

- Установка: 
- Зарегистрировать сервис-провайдер в `config/app.php` 

~~~
/*
 * Протокол обмена информацией с 1С
 */
Timuchen\LaravelCommerceml3\Providers\Exchange1cProvider::class,
~~~

- Опубликовать конфигурацию и изменить при необходимости: `php artisan vendor:publish --tag=Exchange1cConfig`

- Добавить пользователя в базу данных: `php artisan tinker`

~~~
User::create(["name"=> "admin","email"=>"admin@admin.com","password"=>bcrypt("admin")]);
~~~
- В файл .env проекта добавить данные пользователя: 
~~~
1C_EXCHANGE_LOGIN='admin'
1C_EXCHANGE_PASSWORD='admin'
~~~
- Проверить параметр middleware файла конфигурации. Значением этого параметра должен быть массив. В это массиве должен
  быть указан промежуточный слой (middleware) или группа промежуточных слоев, в котором как минимум - стартует сессия
  `\Illuminate\Session\Middleware\StartSession::class`, см. `\App\Http\Kernel`. Если сессия не стартует - ничего работать
  не будет. **Важно** в этой-же группе *middleware* **НЕ ДОЛЖНО** быть класса шифрования куки
  `\App\Http\Middleware\EncryptCookies::class` или любого другого способа шифрования куки, т.к. в 1С передается id сессии
  как есть или если по приходу от 1С будет произведена попытка шифрации/дешифрации - ничего хорошего из этого не будет.

- Установка универсальных моделей для обработки данных в процессе реализации.

### Обработка данных каталога

На определенном этапе 1С отсылает команду начать обработку присланных файлов. 

По мере работы этот метод должен возвращать:
- `self::answerSuccess`, если обработка файла завершена;
- `slef::answerProgress`, если требуется продолжить обработку файла (например большой объём данных);
- `slef::answerFailure`, если произошла ошибка.

В не зависимости от ответа - будет вызван метод `getAnswerDetail()`, который должен вернуть детальный ответ или пустую
строку. 

Если необходимо передать несколько строк - они должны быть разделены символов перевода каретки `\n`.

#### 1C-Битрикс
Описанный на сайте 1С Битрикс протокол CommerceML2 в новых версиях модуля "Битрикс+1С" не поддерживается. 
Здесь сделана попытка реализации недокументированного протокола CommerceML3.1. 
По нашим догадкам CommerceML3.1 - используется исключительно для обмена 1С с БУС.
