# Протокол обмена информацией с 1С

- Установка: 
- Зарегистрировать сервис-провайдер в `config/app.php` 

~~~
/*
 * Протокол обмена информацией с 1С
 */
Timuchen\LaravelCommerceml3\Providers\Exchange1cProvider::class,
~~~

- Опубликовать конфигурацию и изменить при необходимости: `php artisan vendor:publish --tag=Exchange1cConfig`

- Добавить пользователя в базу данных: `php artisan tinker`

~~~
User::create(["name"=> "admin","email"=>"admin@admin.com","password"=>bcrypt("admin")]);
~~~
- В фаул .env проекта добавить данные пользователя: 
~~~
1C_EXCHANGE_LOGIN='admin'
1C_EXCHANGE_PASSWORD='admin'
~~~
- Проверить параметр middleware файла конфигурации. Значением этого параметра должен быть массив. В это массиве должен
  быть указан промежуточный слой (middleware) или группа промежуточных слоев, в котором как минимум - стартует сессия
  `\Illuminate\Session\Middleware\StartSession::class`, см. `\App\Http\Kernel`. Если сессия не стартует - ничего работать
  не будет. **Важно** в этой-же группе *middleware* **НЕ ДОЛЖНО** быть класса шифрования куки
  `\App\Http\Middleware\EncryptCookies::class` или любого другого способа шифрования куки, т.к. в 1С передается id сессии
  как есть или если по приходу от 1С будет произведена попытка шифрации/дешифрации - ничего хорошего из этого не будет.

- Создать модель, которая будет обрабатывать пришедшие данные. Модель должна реализовывать интерфейс
  `\Mavsan\LaProtocol\Interfaces\Import`. Если на стороне 1С используется модуль обмена 1С Битрикс необходимо, чтобы эта
  модель так-же реализовывала интерфейс `\Mavsan\LaProtocol\Interfaces\ImportBitrix`. Контроллер обмена в нужный
  момент создает эту модель и вызывает метод `import`, передавая туда полный путь к файлу, который необходимо обработать.
  Имя этого файла присылает 1С. В файле конфигурации прописать эту модель:

~~~
'catalogWorkModel'   => \App\Model::class,
~~~

### Если на стороне 1С используется модуль обмена 1C Битрикс

[Протокол обмена](https://dev.1c-bitrix.ru/api_help/sale/algorithms/index.php) с 1С Битрикс отличается от стандартного.
В файле конфигурации необходимо настроить соответствующие параметры:


### Обработка данных каталога

На определенном этапе 1С отсылает команду начать обработку присланных файлов. Контроллер создает экземпляр объекта модели,
указанной в конфигурации (ключ конфигурации - `catalogWorkModel`) и вызывает метод `import($fileName)`, где
`$fileName` - имя полный путь к файлу, который требуется обработать.

По мере работы этот метод должен возвращать:
- `self::answerSuccess`, если обработка файла завершена;
- `slef::answerProgress`, если требуется продолжить обработку файла (например большой объём данных);
- `slef::answerFailure`, если произошла ошибка.

В не зависимости от ответа - будет вызван метод `getAnswerDetail()`, который должен вернуть детальный ответ или пустую
строку. Например:
- `обработано 500 записей из 100500`;
- `ошибка: у товара указана группа, но такой группы нет`
- `файл успешно обработан`

Если необходимо передать несколько строк - они должны быть разделены символов перевода каретки `\n`.

#### 1C-Битрикс

В случае, если на стороне 1С используется модуль обмена 1С-Битрикс, необходимо в файле конфигурации параметр `isBitrixOn1C` установить в `true`. Это заставит контроллер отправлять запросы в в виде, который [требует](https://dev.1c-bitrix.ru/api_help/sale/algorithms/index.php) модуль обмена 1C-Битрикс. 

Описанный на сайте 1С Битрикс протокол CommerceML2 в новых версиях модуля "Битрикс+1С" не поддерживается. 
Здесь сделана попытка реализации недокументированного протокола CommerceML3.1. 
По нашим догадкам CommerceML3.1 - используется исключительно для обмена 1С с БУС. 
